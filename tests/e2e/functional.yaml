---
########################################################################################################################
## Test Suite Configuration                                                                                           ##
########################################################################################################################
# Functional tests for aether-webd on a clean Ubuntu 24.04 LXD VM. Installs from the latest GitHub release via the
# hosted install script, verifies meta + system endpoints, then tests the OnRamp provider: information endpoints,
# node management, inventory sync, and Ansible pingall via localhost. Uninstalls with --purge at teardown.
suite: Aether Web User Interface API Test Suite

########################################################################################################################
## Node Infrastructure Configuration                                                                                  ##
########################################################################################################################
# LXD resources: an isolated bridge network, a VM profile with cloud-init that installs curl and jq, and two nodes
# (the local host and a test VM).
lxd:
  # Dedicated bridge network for test-environment traffic
  networks:
    - name: webd-testing
      type: bridge
      subnet: 10.102.102.0/24
      gateway: 10.102.102.1

  # VM profile: 8 CPU / 8 GB RAM / 100 GB disk, cloud-init installs curl + jq
  profiles:
    - name: aether-primary
      description: Profile for the primary test machine
      devices:
        root:
          type: disk
          path: /
          pool: default
          opts:
            size: 100GB
      config:
        limits.cpu: "8"
        limits.memory: "8GB"

        user.user-data: |
          #cloud-config
          package_update: true
          packages:
            - curl
            - jq
            - git
            - make
            - ansible
            - sshpass
          runcmd:
            # Set password for the ubuntu user so Ansible can SSH to localhost
            - [ bash, -c, "echo 'ubuntu:onramp-test' | chpasswd" ]
            # Enable SSH password authentication (base config + drop-in overrides)
            - [ bash, -c, "sed -i 's/^#\\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config" ]
            - [ bash, -c, "sed -i 's/^#\\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config.d/*.conf 2>/dev/null || true" ]
            - [ systemctl, restart, ssh ]
            # Write a file to show cloud-init has finished running
            - [ bash, -c, 'echo "complete" > /tmp/cloud-init.complete' ]


# Nodes: local host (for orchestration) and a clean Ubuntu VM (test target)
nodes:
  - name: localhost
    type: local
    options:
      exec_opts:
        shell: /bin/bash

  - name: test-vm
    type: lxd-vm
    options:
      image: "ubuntu:24.04"
      exec_opts:
        shell: /bin/bash
      networks:
        - name: webd-testing
          ip: 10.102.102.10
      profiles:
        - aether-primary

########################################################################################################################
## Setup — install aether-webd and wait for readiness                                                                 ##
########################################################################################################################
setup:
  - name: "wait for cloud-init to complete"
    node: test-vm
    step:
      type: execute
      options:
        command: while [ ! -f /tmp/cloud-init.complete ]; do sleep 1; done

  - name: "install aether-webd from github release"
    node: test-vm
    step:
      type: execute
      options:
        command: "curl -fsSL https://raw.githubusercontent.com/bengrewell/aether-webui/main/scripts/install.sh | sudo bash"

  - name: "wait for aether-webd service readiness"
    node: test-vm
    step:
      type: execute
      options:
        command: for i in $(seq 1 30); do curl -sf http://localhost:8186/healthz && exit 0; sleep 1; done; exit 1

  - name: "configure Ansible environment for the service"
    node: test-vm
    step:
      type: execute
      options:
        command: |
          sudo bash -c 'printf "ANSIBLE_HOST_KEY_CHECKING=False\nHOME=/var/lib/aether-webd\n" >> /etc/aether-webd/env'
          sudo systemctl restart aether-webd
          for i in $(seq 1 30); do curl -sf http://localhost:8186/healthz && exit 0; sleep 1; done; exit 1

  - name: "wait for OnRamp repo clone to complete"
    node: test-vm
    step:
      type: execute
      options:
        command: for i in $(seq 1 120); do curl -sf http://localhost:8186/api/v1/onramp/repo | jq -e '.cloned == true' && exit 0; sleep 1; done; exit 1

########################################################################################################################
## Tests — API endpoint validation                                                                                    ##
########################################################################################################################
tests:
  - name: "health check returns healthy"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/healthz
      evaluate:
        exit_code: 0
        contains: "healthy"

  - name: "version endpoint returns release build values"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/version | jq -e '.version != "dev" and .build_date != "unknown" and .branch != "unknown" and .commit_hash != "unknown"'
      evaluate:
        exit_code: 0

  - name: "build endpoint returns Go toolchain info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/build | jq -e '.go_version != "" and .os != "" and .arch != ""'
      evaluate:
        exit_code: 0

  - name: "runtime endpoint returns process info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/runtime | jq -e '.pid > 0 and .binary_path != "" and .uptime != "" and .user.uid != null and .group.gid != null'
      evaluate:
        exit_code: 0

  - name: "config endpoint returns application config"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/config | jq -e '.listen_address != "" and (.security | has("tls_enabled")) and .storage.data_dir != "" and .schema_version >= 0'
      evaluate:
        exit_code: 0

  - name: "providers endpoint returns registered providers"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/providers | jq -e '.providers | length > 0 and all(has("name", "enabled", "endpoint_count"))'
      evaluate:
        exit_code: 0

  - name: "store endpoint returns health diagnostics"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/store | jq -e '.engine == "sqlite" and .status != null and (.diagnostics | length > 0 and all(has("name", "passed")))'
      evaluate:
        exit_code: 0

  - name: "cpu endpoint returns processor info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/cpu | jq -e '.model != "" and .physical_cores >= 1 and .logical_cores >= 1'
      evaluate:
        exit_code: 0

  - name: "memory endpoint returns usage info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/memory | jq -e '.total_bytes > 0 and .usage_percent >= 0'
      evaluate:
        exit_code: 0

  - name: "disks endpoint returns partition info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/disks | jq -e '.partitions | length > 0 and .[0].device != null and .[0].mountpoint != null and .[0].total_bytes > 0'
      evaluate:
        exit_code: 0

  - name: "os endpoint returns host info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/os | jq -e '.os == "linux" and .hostname != "" and .platform != "" and .uptime_seconds > 0'
      evaluate:
        exit_code: 0

  - name: "network interfaces endpoint returns interface list"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/network/interfaces | jq -e 'length > 0 and .[0].name != null and .[0].mtu > 0'
      evaluate:
        exit_code: 0

  - name: "network config endpoint returns DNS configuration"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/network/config | jq -e '.dns_servers | length > 0'
      evaluate:
        exit_code: 0

  - name: "network ports endpoint returns listening sockets"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/network/ports | jq -e 'length > 0 and any(.[]; .local_port == 8186)'
      evaluate:
        exit_code: 0

  - name: "metrics endpoint returns time-series data"
    node: test-vm
    type: execute
    options:
      command: 'curl -sf "http://localhost:8186/api/v1/system/metrics?metric=system.cpu.usage_percent" | jq -e ''.series | type == "array"'''
      evaluate:
        exit_code: 0

  ######################################################################################################################
  ## OnRamp provider — information endpoints                                                                          ##
  ######################################################################################################################

  - name: "repo status shows cloned repo"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/repo | jq -e '.cloned == true and .dir != "" and .commit != ""'
      evaluate:
        exit_code: 0

  - name: "components list returns all registered"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/components | jq -e 'length == 12 and any(.[]; .name == "k8s") and any(.[]; .name == "cluster")'
      evaluate:
        exit_code: 0

  - name: "get single component returns actions"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/components/cluster | jq -e '.name == "cluster" and (.actions | length > 0) and any(.actions[]; .name == "pingall")'
      evaluate:
        exit_code: 0

  - name: "config returns parsed vars"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/config | jq -e 'has("k8s") or has("core") or . == {}'
      evaluate:
        exit_code: 0

  - name: "profiles list returns array"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/config/profiles | jq -e 'type == "array"'
      evaluate:
        exit_code: 0

  - name: "tasks list initially empty"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/tasks | jq -e 'type == "array"'
      evaluate:
        exit_code: 0

  - name: "inventory initially has nodes array"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/inventory | jq -e '.nodes | type == "array"'
      evaluate:
        exit_code: 0

  ######################################################################################################################
  ## OnRamp provider — node management, inventory sync, and pingall                                                   ##
  ######################################################################################################################

  - name: "create localhost node with all roles"
    node: test-vm
    type: execute
    options:
      command: >-
        curl -sf -X POST http://localhost:8186/api/v1/nodes
        -H 'Content-Type: application/json'
        -d '{"name":"localhost","ansible_host":"127.0.0.1","ansible_user":"ubuntu","password":"onramp-test","sudo_password":"onramp-test","roles":["master","worker","gnbsim","oai","ueransim","srsran","oscric","n3iwf"]}'
        | jq -e '.id != "" and .has_password == true'
      evaluate:
        exit_code: 0

  - name: "list nodes returns created node"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/nodes | jq -e 'length == 1 and .[0].name == "localhost"'
      evaluate:
        exit_code: 0

  - name: "sync inventory to hosts.ini"
    node: test-vm
    type: execute
    options:
      command: curl -sf -X POST http://localhost:8186/api/v1/onramp/inventory/sync | jq -e '.message | test("1 nodes")'
      evaluate:
        exit_code: 0

  - name: "get inventory shows localhost with all roles"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/inventory | jq -e '.nodes | length == 1 and .[0].name == "localhost" and (.[0].roles | length == 8)'
      evaluate:
        exit_code: 0

  - name: "execute pingall action"
    node: test-vm
    type: execute
    options:
      command: curl -sf -X POST http://localhost:8186/api/v1/onramp/components/cluster/pingall | jq -r '.id' | tee /tmp/pingall_task_id
      evaluate:
        exit_code: 0

  - name: "wait for pingall to complete"
    node: test-vm
    type: execute
    options:
      command: >-
        TASK_ID=$(cat /tmp/pingall_task_id);
        for i in $(seq 1 120); do
          STATUS=$(curl -sf "http://localhost:8186/api/v1/onramp/tasks/${TASK_ID}" | jq -r '.status');
          [ "$STATUS" != "running" ] && exit 0;
          sleep 1;
        done;
        exit 1

  - name: "verify pingall succeeded"
    node: test-vm
    type: execute
    options:
      command: >-
        TASK_ID=$(cat /tmp/pingall_task_id);
        curl -sf "http://localhost:8186/api/v1/onramp/tasks/${TASK_ID}" | jq -e '.status == "succeeded" and .exit_code == 0'
      evaluate:
        exit_code: 0

  - name: "dump pingall task output on failure"
    node: test-vm
    type: execute
    options:
      command: >-
        TASK_ID=$(cat /tmp/pingall_task_id);
        STATUS=$(curl -sf "http://localhost:8186/api/v1/onramp/tasks/${TASK_ID}" | jq -r '.status');
        if [ "$STATUS" != "succeeded" ]; then
          echo "=== Task status: $STATUS ===";
          curl -sf "http://localhost:8186/api/v1/onramp/tasks/${TASK_ID}" | jq '{status, exit_code, component, action, started_at, finished_at}';
          echo "=== Task output ===";
          curl -sf "http://localhost:8186/api/v1/onramp/tasks/${TASK_ID}" | jq -r '.output';
        fi;
        exit 0

  - name: "tasks list includes completed pingall"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/onramp/tasks | jq -e 'length > 0 and any(.[]; .component == "cluster" and .action == "pingall")'
      evaluate:
        exit_code: 0

########################################################################################################################
## Teardown — clean uninstall                                                                                         ##
########################################################################################################################
teardown:
  - name: "uninstall aether-webd"
    node: test-vm
    step:
      type: execute
      options:
        command: curl -fsSL https://raw.githubusercontent.com/bengrewell/aether-webui/main/scripts/uninstall.sh | sudo bash -s -- --purge
