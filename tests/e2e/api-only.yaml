---
########################################################################################################################
## Test Suite Configuration                                                                                           ##
########################################################################################################################
# API smoke tests for aether-webd on a clean Ubuntu 24.04 LXD VM. Installs from the latest GitHub release via the
# hosted install script, verifies the systemd service starts and responds to health/version API requests, then
# uninstalls with --purge.
suite: Aether Web User Interface API Test Suite

########################################################################################################################
## Node Infrastructure Configuration                                                                                  ##
########################################################################################################################
# LXD resources: an isolated bridge network, a VM profile with cloud-init that installs curl and jq, and two nodes
# (the local host and a test VM).
lxd:
  # Dedicated bridge network for test-environment traffic
  networks:
    - name: webd-testing
      type: bridge
      subnet: 10.102.102.0/24
      gateway: 10.102.102.1

  # VM profile: 8 CPU / 8 GB RAM / 100 GB disk, cloud-init installs curl + jq
  profiles:
    - name: aether-primary
      description: Profile for the primary test machine
      devices:
        root:
          type: disk
          path: /
          pool: default
          opts:
            size: 100GB
      config:
        limits.cpu: "8"
        limits.memory: "8GB"

        user.user-data: |
          #cloud-config
          package_update: true
          packages:
            - curl
            - jq
          runcmd:
            # Write a file to show cloud-init has finished running
            - [ bash, -c, 'echo "complete" > /tmp/cloud-init.complete' ]


# Nodes: local host (for orchestration) and a clean Ubuntu VM (test target)
nodes:
  - name: localhost
    type: local
    options:
      exec_opts:
        shell: /bin/bash

  - name: test-vm
    type: lxd-vm
    options:
      image: "ubuntu:24.04"
      exec_opts:
        shell: /bin/bash
      networks:
        - name: webd-testing
          ip: 10.102.102.10
      profiles:
        - aether-primary

########################################################################################################################
## Setup — install aether-webd and wait for readiness                                                                 ##
########################################################################################################################
setup:
  - name: "wait for cloud-init to complete"
    node: test-vm
    step:
      type: execute
      options:
        command: while [ ! -f /tmp/cloud-init.complete ]; do sleep 1; done

  - name: "install aether-webd from github release"
    node: test-vm
    step:
      type: execute
      options:
        command: "curl -fsSL https://raw.githubusercontent.com/bengrewell/aether-webui/main/scripts/install.sh | sudo bash"

  - name: "wait for aether-webd service readiness"
    node: test-vm
    step:
      type: execute
      options:
        command: for i in $(seq 1 30); do curl -sf http://localhost:8186/healthz && exit 0; sleep 1; done; exit 1

########################################################################################################################
## Tests — API endpoint validation                                                                                    ##
########################################################################################################################
tests:
  - name: "health check returns healthy"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/healthz
      evaluate:
        exit_code: 0
        contains: "healthy"

  - name: "version endpoint returns release build values"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/version | jq -e '.version != "dev" and .build_date != "unknown" and .branch != "unknown" and .commit_hash != "unknown"'
      evaluate:
        exit_code: 0

  - name: "build endpoint returns Go toolchain info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/build | jq -e '.go_version != "" and .os != "" and .arch != ""'
      evaluate:
        exit_code: 0

  - name: "runtime endpoint returns process info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/runtime | jq -e '.pid > 0 and .binary_path != "" and .uptime != "" and .user.uid != null and .group.gid != null'
      evaluate:
        exit_code: 0

  - name: "config endpoint returns application config"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/config | jq -e '.listen_address != "" and (.security | has("tls_enabled")) and .storage.data_dir != "" and .schema_version >= 0'
      evaluate:
        exit_code: 0

  - name: "providers endpoint returns registered providers"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/providers | jq -e '.providers | length > 0 and all(has("name", "enabled", "endpoint_count"))'
      evaluate:
        exit_code: 0

  - name: "store endpoint returns health diagnostics"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/meta/store | jq -e '.engine == "sqlite" and .status != null and (.diagnostics | length > 0 and all(has("name", "passed")))'
      evaluate:
        exit_code: 0

  - name: "cpu endpoint returns processor info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/cpu | jq -e '.model != "" and .physical_cores >= 1 and .logical_cores >= 1'
      evaluate:
        exit_code: 0

  - name: "memory endpoint returns usage info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/memory | jq -e '.total_bytes > 0 and .usage_percent >= 0'
      evaluate:
        exit_code: 0

  - name: "disks endpoint returns partition info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/disks | jq -e '.partitions | length > 0 and .[0].device != null and .[0].mountpoint != null and .[0].total_bytes > 0'
      evaluate:
        exit_code: 0

  - name: "os endpoint returns host info"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/os | jq -e '.os == "linux" and .hostname != "" and .platform != "" and .uptime_seconds > 0'
      evaluate:
        exit_code: 0

  - name: "network interfaces endpoint returns interface list"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/network/interfaces | jq -e 'length > 0 and .[0].name != null and .[0].mtu > 0'
      evaluate:
        exit_code: 0

  - name: "network config endpoint returns DNS configuration"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/network/config | jq -e '.dns_servers | length > 0'
      evaluate:
        exit_code: 0

  - name: "network ports endpoint returns listening sockets"
    node: test-vm
    type: execute
    options:
      command: curl -sf http://localhost:8186/api/v1/system/network/ports | jq -e 'length > 0 and any(.[]; .local_port == 8186)'
      evaluate:
        exit_code: 0

  - name: "metrics endpoint returns time-series data"
    node: test-vm
    type: execute
    options:
      command: 'curl -sf "http://localhost:8186/api/v1/system/metrics?metric=system.cpu.usage_percent" | jq -e ''.series | type == "array"'''
      evaluate:
        exit_code: 0

########################################################################################################################
## Teardown — clean uninstall                                                                                         ##
########################################################################################################################
teardown:
  - name: "uninstall aether-webd"
    node: test-vm
    step:
      type: execute
      options:
        command: curl -fsSL https://raw.githubusercontent.com/bengrewell/aether-webui/main/scripts/uninstall.sh | sudo bash -s -- --purge
